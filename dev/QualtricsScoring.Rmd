---
title: "R Notebook"
output: html_notebook
---

```{r}
require(tidyverse)
require(readxl)
```

```{r}
d_raw <- read_xlsx('/Users/Keith Yoder/Desktop/MoralChoiceTest_October+11,+2021_08.56/MoralChoiceTest_October 11, 2021_08.56.xlsx',
               skip=1)

d_real <- d_raw %>% filter(!is.na(`Please enter your age in years`))
d_real$SID <- factor(d_real$`Response ID`)
d_real %>% head()
```

```{r}
# extract_js <- function(df, col_name, col_label, trials=100) {
#   df_out <- df %>%
#     separate(!!as.name(col_name), into=str_c(col_label, c(1:trials)),
#              sep = ",") %>%
#     separate(!!as.name(str_c(col_label,'1')), into=c(NA, str_c(col_label,'1')),
#                        sep="\\[") %>%
#     separate(!!as.name(str_c(col_label,trials)),
#                        into=c(str_c(col_label,trials), NA),
#                        sep="]")
#   return(df_out)
# }

extract_js2 <- function(df, col_name, col_label, trials=100) {
  clean_label = str_c(col_name, '_clean')
  df_out <- df %>%
    mutate({{clean_label}} := str_remove_all(!!as.name(col_name),
                            '[\\[\\]values\\}\\{\\:\"]')) %>%
    separate(!!as.name(clean_label), into=str_c(col_label, c(1:trials)),
             sep = ",") %>%
    select(-{{col_name}})
  return(df_out)
  
}


extract_js_text <- function(df, col_name, col_label, trials=80, n_iss=36) {
  old_names <- str_c(col_label, c(1:trials))
  new_names <- str_c(col_label, c(1:n_iss))
  keep_idx <- seq(4, (n_iss*2)+2, 2)
  
  df_out <- df %>%
    separate({{col_name}}, into=old_names, sep='\"') %>%
    select(SID,str_c(col_label, keep_idx)) %>%
    rename_at(vars(old_names[keep_idx]), ~ new_names)
    
  return(df_out)
  
}

```

  
```{r}
d_support <- d_real %>%
  select(SID, support) %>%
  extract_js2('support', 'Support', trials=36) %>%
  pivot_longer(Support1:Support36, values_to = "Support") %>%
  separate(name, into=c("Type", "Trial"), sep=7, remove=FALSE) %>%
  select(SID, Trial, Support)
d_moral <- d_real %>%
  select(SID, moral) %>%
  extract_js2('moral', 'Moral', trials=36) %>%
  pivot_longer(Moral1:Moral36, values_to = "Moral") %>%
  separate(name, into=c("Type", "Trial"), sep=5, remove=FALSE) %>%
  select(SID, Trial, Moral)
d_familiar <- d_real %>%
  select(SID, familiar) %>%
  extract_js2('familiar', 'Familiar', trials=36) %>%
  pivot_longer(Familiar1:Familiar36, values_to = "Familiar") %>%
  separate(name, into=c("Type", "Trial"), sep=8, remove=FALSE) %>%
  select(SID, Trial, Familiar)
d_issue <- d_real %>%
  select(SID, issues) %>%
  extract_js_text('issues', 'Issue') %>%
  pivot_longer(Issue1:Issue36, values_to = "Issue") %>%
  separate(name, into=c("Type", "Trial"), sep=5, remove=FALSE) %>%
  select(SID, Trial, Issue) %>%
  mutate(Issue = as.factor(Issue))
  
d_view <- d_support %>%
  left_join(d_moral, by=c("SID", "Trial")) %>%
  left_join(d_familiar, by=c("SID", "Trial")) %>%
  left_join(d_issue, by=c('SID', 'Trial')) %>%
  mutate_if(is.character, as.numeric)
```
  
```{r}
d_choice <- d_real %>%
  select(SID, choice_resp) %>%
  extract_js2('choice_resp', "Resp", trials=100) %>%
  pivot_longer(Resp1:Resp100, values_to = "Resp") %>%
  separate(name, into=c("Type", "Trial"), sep=4, remove=FALSE) %>%
  select(SID, Trial, Resp) %>%
  mutate(Response = case_when(
    Resp == "f" ~ 1,
    Resp == "j" ~ 2
  )) %>%
  mutate(ChooseLeft = case_when(
    Response == 1 ~ 1,
    Response == 2 ~ 0
  ))


d_rt <- d_real %>%
  select(SID, choice_rt) %>%
  extract_js2('choice_rt', "RT", trials=100) %>%
  pivot_longer(RT1:RT100, values_to = "RT") %>%
  separate(name, into=c("Type", "Trial"), sep=2, remove=FALSE) %>%
  select(SID, Trial, RT) %>%
  mutate(RT = as.double(RT))

d_issue_l <- d_real %>%
  select(SID, issue_left) %>%
  extract_js_text('issue_left', 'IssueLeft', trials=260, n_iss = 100) %>%
  pivot_longer(IssueLeft1:IssueLeft100, values_to = "IssueLeft") %>%
  separate(name, into=c("Type", "Trial"), sep=9, remove=FALSE) %>%
  select(SID, Trial, IssueLeft) %>%
  mutate(IssueLeft = as.factor(IssueLeft))

d_issue_r <- d_real %>%
  select(SID, issue_right) %>%
  extract_js_text('issue_right', 'IssueRight', trials=260, n_iss = 100) %>%
  pivot_longer(IssueRight1:IssueRight100, values_to = "IssueRight") %>%
  separate(name, into=c("Type", "Trial"), sep=10, remove=FALSE) %>%
  select(SID, Trial, IssueRight) %>%
  mutate(IssueRight = as.factor(IssueRight))

d_choices <- d_choice %>%
  left_join(d_rt, by=c("SID", "Trial")) %>%
  left_join(d_issue_l, by=c("SID", "Trial")) %>%
  left_join(d_issue_r, by=c('SID', 'Trial')) %>%
  mutate(Trial = as.numeric(Trial))
```

```{r}
prior_col <- c('Support', 'Moral', 'Familiar')
d <- d_choices %>%
  left_join(d_view %>% select(-Trial), 
            by=c("SID"="SID", "IssueLeft"="Issue")) %>%
  rename_at(vars(prior_col), ~ str_c('Left', prior_col)) %>%
  left_join(d_view %>% select(-Trial),
            by=c("SID"="SID", "IssueRight"="Issue")) %>%
  rename_at(vars(prior_col), ~ str_c('Right', prior_col)) %>%
  mutate(ChoiceSupport = case_when(
    Response == 1 ~ LeftSupport - RightSupport,
    Response == 2 ~ RightSupport - LeftSupport,
    TRUE ~ NA_real_
  )) %>%
  mutate(ChoiceMoral = case_when(
    Response == 1 ~ LeftMoral - RightMoral,
    Response == 2 ~ RightMoral - LeftMoral,
    TRUE ~ NA_real_
  )) %>%
  mutate(ChoiceSupportDist = abs(ChoiceSupport)) %>%
  mutate(ChoiceMoralDist = abs(ChoiceMoral))
```

```{r}
d <- d %>%
  mutate(RTs = RT / 1000)
```

```{r}
d %>% write_csv('ChoiceData.csv')
```


```{r}
d_trim <- d %>%
  filter(RT < 60000 & RT > 150)

```

```{r}
choice.df <- data.frame(
  subjID = as.numeric(d$SID),
  choice = as.numeric(d$Response),
  RT = as.double(d$RTs)
)

choice.mod <- hBayesDM::choiceRT_ddm(choice.df %>% filter(subjID %in% c(1,2)))
```

```{r}
plot(choice.mod, type="trace")
```

```{r}
plot(choice.mod)
```



```{r}
mod <- lmerTest::lmer(RT ~ ChoiceSupportDist*ChoiceMoralDist +
                    (1|SID) + (1|IssueLeft), data=d_trim)
summary(mod)

mod2 <- lme4::glmer(ChooseLeft ~ LeftSupport*LeftMoral +
                          (1|SID) + (1|IssueLeft),
                        data = d_trim, family=binomial)
```

```{r}
require(rethinking)
dat_list <- list(
  ChooseLeft = d_trim$ChooseLeft,
  M = d_trim$ChoiceMoral / 8,
  S = d_trim$ChoiceSupport / 6,
  Issue = as.numeric(d_trim$IssueLeft),
  SID = as.numeric(d_trim$SID)
)

modb <- ulam(
  alist(
    ChooseLeft ~ dbinom(1, p),
    logit(p) <- a[SID] + g[Issue] + bS*S + bM*M,
    bS ~ normal(0, 1),
    bM ~ normal(0, 1),
    a[SID] ~ dnorm(a_bar, sigma_a),
    g[Issue] ~ dnorm(0, sigma_g),
    a_bar ~ dnorm(0, 1.5),
    sigma_a ~ dexp(1),
    sigma_g ~ dexp(1)
  ), data = dat_list, chains=4, cores=4, log_lik=TRUE
)
```

```{r}
trankplot(modb)
```

```{r}
precis(modb)
```

