---
title: "R Notebook"
output: html_notebook
---

```{r}
require(tidyverse)
require(readxl)
```

# Import data
```{r}
d_raw <- read_xlsx('../../scratch-foo/data/moral_choice/batch_3.xlsx',
               skip=1)

d_real <- d_raw %>% filter(!is.na(`Please enter your gender`))
d_real$SID <- factor(d_real$`Response ID`)
print(str_c(nrow(d_raw)," subjects"))
d_real %>% head()
```

```{r}
# extract_js <- function(df, col_name, col_label, trials=100) {
#   df_out <- df %>%
#     separate(!!as.name(col_name), into=str_c(col_label, c(1:trials)),
#              sep = ",") %>%
#     separate(!!as.name(str_c(col_label,'1')), into=c(NA, str_c(col_label,'1')),
#                        sep="\\[") %>%
#     separate(!!as.name(str_c(col_label,trials)),
#                        into=c(str_c(col_label,trials), NA),
#                        sep="]")
#   return(df_out)
# }

extract_js2 <- function(df, col_name, col_label, trials=100) {
  clean_label = str_c(col_name, '_clean')
  df_out <- df %>%
    mutate({{clean_label}} := str_remove_all(!!as.name(col_name),
                            '[\\[\\]values\\}\\{\\:\"]')) %>%
    separate(!!as.name(clean_label), into=str_c(col_label, c(1:trials)),
             sep = ",") %>%
    select(-{{col_name}})
  return(df_out)
  
}


extract_js_text <- function(df, col_name, col_label, trials=80, n_iss=36) {
  old_names <- str_c(col_label, c(1:trials))
  new_names <- str_c(col_label, c(1:n_iss))
  keep_idx <- seq(4, (n_iss*2)+2, 2)
  
  df_out <- df %>%
    separate({{col_name}}, into=old_names, sep='\"') %>%
    select(SID,str_c(col_label, keep_idx)) %>%
    rename_at(vars(old_names[keep_idx]), ~ new_names)
    
  return(df_out)
  
}

```

  
```{r}
d_support <- d_real %>%
  select(SID, support) %>%
  extract_js2('support', 'Support', trials=36) %>%
  pivot_longer(Support1:Support36, values_to = "Support") %>%
  separate(name, into=c("Type", "Trial"), sep=7, remove=FALSE) %>%
  select(SID, Trial, Support)
d_moral <- d_real %>%
  select(SID, moral) %>%
  extract_js2('moral', 'Moral', trials=36) %>%
  pivot_longer(Moral1:Moral36, values_to = "Moral") %>%
  separate(name, into=c("Type", "Trial"), sep=5, remove=FALSE) %>%
  select(SID, Trial, Moral)
d_familiar <- d_real %>%
  select(SID, familiar) %>%
  extract_js2('familiar', 'Familiar', trials=36) %>%
  pivot_longer(Familiar1:Familiar36, values_to = "Familiar") %>%
  separate(name, into=c("Type", "Trial"), sep=8, remove=FALSE) %>%
  select(SID, Trial, Familiar)
d_issue <- d_real %>%
  select(SID, issues) %>%
  extract_js_text('issues', 'Issue') %>%
  pivot_longer(Issue1:Issue36, values_to = "Issue") %>%
  separate(name, into=c("Type", "Trial"), sep=5, remove=FALSE) %>%
  select(SID, Trial, Issue) %>%
  mutate(Issue = as.factor(Issue))
  
d_view <- d_support %>%
  left_join(d_moral, by=c("SID", "Trial")) %>%
  left_join(d_familiar, by=c("SID", "Trial")) %>%
  left_join(d_issue, by=c('SID', 'Trial')) %>%
  mutate_if(is.character, as.numeric) %>%
  group_by(SID) %>%
  mutate(Support_z = 
           (Support - mean(Support, na.rm=TRUE)) / 
           sd(Support, na.rm=TRUE)) %>%
  ungroup()

dt <- d_view %>% 
  mutate(S = Support - 3) %>% 
  mutate(M = Moral-4) %>% 
  mutate(SM = str_c(S,M)) %>% 
  mutate(SMn = str_c(S*-1,M))

subvals <- dt %>% 
  select(SID, SM) %>% 
  left_join(dt %>% select(SID, SMn), by="SID")

subval <- tibble(SID = rep(subvals$SID, 2),
                 SM = c(subvals$SM, subvals$SMn))

subval %>% 
  filter(!duplicated(select(., c(SID, SM) ))) %>% 
  count(SID)
```
  
```{r}
d_choice <- d_real %>%
  select(SID, choice_resp) %>%
  extract_js2('choice_resp', "Resp", trials=100) %>%
  pivot_longer(Resp1:Resp100, values_to = "Resp") %>%
  separate(name, into=c("Type", "Trial"), sep=4, remove=FALSE) %>%
  select(SID, Trial, Resp) %>%
  mutate(Response = case_when(
    Resp == "f" ~ 1,
    Resp == "j" ~ 2
  )) %>%
  mutate(ChooseLeft = case_when(
    Response == 1 ~ 1,
    Response == 2 ~ 0
  ))


d_rt <- d_real %>%
  select(SID, choice_rt) %>%
  extract_js2('choice_rt', "RT", trials=100) %>%
  pivot_longer(RT1:RT100, values_to = "RT") %>%
  separate(name, into=c("Type", "Trial"), sep=2, remove=FALSE) %>%
  select(SID, Trial, RT) %>%
  mutate(RT = as.double(RT))

d_issue_l <- d_real %>%
  select(SID, issue_left) %>%
  extract_js_text('issue_left', 'IssueLeft', trials=260, n_iss = 100) %>%
  pivot_longer(IssueLeft1:IssueLeft100, values_to = "IssueLeft") %>%
  separate(name, into=c("Type", "Trial"), sep=9, remove=FALSE) %>%
  select(SID, Trial, IssueLeft) %>%
  mutate(IssueLeft = as.factor(IssueLeft))

d_issue_r <- d_real %>%
  select(SID, issue_right) %>%
  extract_js_text('issue_right', 'IssueRight', trials=260, n_iss = 100) %>%
  pivot_longer(IssueRight1:IssueRight100, values_to = "IssueRight") %>%
  separate(name, into=c("Type", "Trial"), sep=10, remove=FALSE) %>%
  select(SID, Trial, IssueRight) %>%
  mutate(IssueRight = as.factor(IssueRight))

d_pos_l <- d_real %>%
  select(SID, position_left) %>%
  extract_js_text('position_left', 'PosLeft', trials=260, n_iss = 100) %>%
  pivot_longer(PosLeft1:PosLeft100, values_to = "PosLeft") %>%
  separate(name, into=c("Type", "Trial"), sep=7, remove=FALSE) %>%
  select(SID, Trial, PosLeft) %>%
  mutate(PosLeft = case_when(
    PosLeft == "ThumbsUp.jpg" ~ 1,
    PosLeft == "ThumbsDown.jpg" ~ -1))

d_pos_r <- d_real %>%
  select(SID, position_right) %>%
  extract_js_text('position_right', 'PosRight', trials=260, n_iss = 100) %>%
  pivot_longer(PosRight1:PosRight100, values_to = "PosRight") %>%
  separate(name, into=c("Type", "Trial"), sep=8, remove=FALSE) %>%
  select(SID, Trial, PosRight) %>%
  mutate(PosRight = case_when(
    PosRight == "ThumbsUp.jpg" ~ 1,
    PosRight == "ThumbsDown.jpg" ~ -1))

d_choices <- d_choice %>%
  left_join(d_rt, by=c("SID", "Trial")) %>%
  left_join(d_issue_l, by=c("SID", "Trial")) %>%
  left_join(d_issue_r, by=c('SID', 'Trial')) %>%
  left_join(d_pos_l, by=c('SID', 'Trial')) %>%
  left_join(d_pos_r, by=c('SID', 'Trial')) %>%
  mutate(Trial = as.numeric(Trial))
```

```{r}
prior_col <- c('Support', 'Moral', 'Familiar')
d <- d_choices %>%
  filter(!is.na(Resp)) %>%
  left_join(d_view %>% select(-Trial), 
            by=c("SID"="SID", "IssueLeft"="Issue")) %>%
  mutate(Support = Support - 3) %>%
  rename_at(vars(prior_col), ~ str_c('Left', prior_col)) %>%
  left_join(d_view %>% select(-Trial),
            by=c("SID"="SID", "IssueRight"="Issue")) %>%
  mutate(Support = Support - 3) %>%
  rename_at(vars(prior_col), ~ str_c('Right', prior_col)) %>%
  mutate(LeftAdj = LeftSupport * PosLeft) %>%
  mutate(RightAdj = RightSupport * PosRight) %>%
  mutate(ChoiceSupport = case_when(
    Response == 1 ~ LeftAdj - RightAdj,
    Response == 2 ~ RightAdj - LeftAdj,
    TRUE ~ NA_real_
  )) %>%
  mutate(ChoiceSupportNaive = case_when(
    Response == 1 ~ LeftSupport - RightSupport,
    Response == 2 ~ RightSupport - LeftSupport,
    TRUE ~ NA_real_
  )) %>%
  mutate(ChoiceMoral = case_when(
    Response == 1 ~ LeftMoral - RightMoral,
    Response == 2 ~ RightMoral - LeftMoral,
    TRUE ~ NA_real_
  )) %>%
  mutate(ChoiceSupportDist = abs(ChoiceSupport)) %>%
  mutate(ChoiceMoralDist = abs(ChoiceMoral)) %>%
  mutate(LeftAdjDiff = LeftAdj- RightAdj) %>%
  mutate(RightAdjDiff = RightAdj - LeftAdj) %>%
  mutate(LeftDiff_raw = LeftSupport - RightSupport) %>%
  mutate(LeftMoral_diff = LeftMoral - RightMoral) %>%
  mutate(ChooseRight = case_when(
    ChooseLeft == 1 ~ 0,
    ChooseLeft == 0 ~ 1,
    TRUE ~ NA_real_
  )) %>%
  mutate(Choice = case_when(
    ChooseLeft == 1 ~ "Left",
    ChooseLeft == 0 ~ "Right"
  ))

d <- d %>%
  mutate(RTs = RT / 1000) %>%
  mutate(Subj = as.numeric(SID))

d %>% select(Subj, everything()) %>% write_csv('ChoiceData.csv')
d %>% select(Subj, everything()) %>% 
  filter(RT < 60000 & RT > 150) %>% 
  write_csv('ChoiceData_trim.csv')


d_trim <- d %>%
  filter(RT < 60000 & RT > 150) %>%
  mutate(Subj = as.numeric(as.factor(as.character(SID))))

```

```{r}
d_trim$Subject <- as.factor(d_trim$Subj)

ggplot(d_trim, aes(LeftAdjDiff, Choice)) +
  geom_boxplot(aes(color=Subject)) +
  geom_violin(aes(fill=Choice),
              draw_quantiles=c(.25,.5,.75), alpha=.3) +
  theme_classic() +
  guides(fill = "none")
ggsave('Choice_by_Support.png')
```

```{r}
require(rethinking)
```



```{r}
require(lme4)
resp_mod <- glmer(ChooseLeft ~ LeftAdjDiff +
                    (1|Subject), data = d_trim,
                    family='binomial')
resp_mod2 <- glmer(ChooseLeft ~ LeftMoral_diff +
                    (1|Subject), data = d_trim,
                    family='binomial')
resp_mod3 <- glmer(ChooseLeft ~ LeftAdjDiff + LeftMoral_diff +
                    (1|Subject), data = d_trim,
                    family='binomial')
resp_mod4 <- glmer(ChooseLeft ~ LeftAdjDiff * LeftMoral_diff +
                    (1|Subject), data = d_trim,
                    family='binomial')
anova(resp_mod, resp_mod2, resp_mod3, resp_mod4)
```
```{r}
require(sjPlot)
plot_model(resp_mod, type="pred", terms=c('LeftAdjDiff')) +
  labs(x="Support (Left - Right)", y="Probability of choose") +
  theme_classic()
```

```{r}
plot_model(resp_mod4, type="int", 
           terms = c("LeftAdjDiff", "LeftMoral_diff"),
           mdrt.values="minmax") +
  labs(x="Support (Left - Right)", y="Probability of choose",
       color="MC (min/max)") +
  theme_classic()
```


```{r}
ggplot(d_trim %>% filter(RTs < 30), aes(LeftAdjDiff, RTs)) +
  geom_point(aes(color=Subject), alpha=.3) +
  geom_smooth(aes(color=Subject), formula = y ~ x^2, se=FALSE) +
  geom_smooth(formula=y ~ x^2) +
  theme_classic()
```


```{r}
ggplot(d_trim %>% filter(RTs < 5), aes(LeftAdjDiff, RTs)) +
  geom_point(aes(color=Subject), alpha=.3) +
  geom_smooth(aes(color=Subject), se=FALSE) +
  geom_smooth(size=2) +
  theme_classic()
```


```{r}
ggplot(d_trim, aes(ChoiceSupportNaive, Choice)) +
  geom_boxplot(aes(color=Subject)) +
  geom_violin(aes(fill=Choice),
              draw_quantiles=c(.25,.5,.75), alpha=.3) +
  theme_classic()
```

## ulam for response
$$\begin{equation}
L_i ~ \text{Binomial}(1, p_i) \\
\text{logit}(p_i) = \alpha_{\text{SID}[i]} + \beta_{\text{SID}[i]}*RDV \\
\alpha_{\text{SID}[i]} = 
\end{equation}$$

```{r}
dat_listr <- list(
  L = d_trim$ChooseLeft,
  RDV = d_trim$LeftAdjDiff,
  sid = d_trim$Subj
)
  
  
resp.ulam <- ulam(
  alist(
    L ~ dbinom(1, p),
    logit(p) <- a_sid[sid] + b_sid[sid]*RDV,
    
    # adaptive priors
    c(a_sid, b_sid)[sid] ~ multi_normal( c(a,b), Rho, sigma_sid),
    a ~ normal(5, 2),
    b ~ normal(-1, 0.5),
    sigma_sid ~ exponential(1),
    Rho ~ dlkjcorr(2)
  ), data = dat_listr, chains=4, cores=4, iter=2000
)
```
```{r}
dat_tib <- as_tibble(dat_listr)
dat_tib
```
```{r}
acp <- dat_tib %>%
  group_by(sid, RDV) %>%
  summarize(L = mean(L, na.rm=TRUE))

acpm <- acp %>%
  group_by(RDV) %>%
  summarize(L = mean(L, na.rm=TRUE))
```



```{r}
png('ValueMCMC.png', width=800, height=450)
par(mfrow=c(1,2))
plot(NULL, xlim=c(-6, 6), ylim=c(0, 1),
     xlab="Relative value of Left",
     ylab="% of Left",
      main="Raw data")
for (i in 1:length(unique(acp$sid))) {
  sdat <- acp %>%
    filter(sid == i)
  x <- unique(sdat$RDV)
  lines(x, sdat$L, col=grau(0.25))
}
lines(acpm$RDV, acpm$L, lwd=2)

plot(NULL, xlim=c(-6, 6), ylim=c(0, 1),
     xlab="Relative value of Left", 
     ylab="Pr(Left)",
     main="Posterior predictions (20 draws)")
xseq <- seq(from=-6, to=6, by=1)
post <- extract.samples(resp.ulam)

for (i in 1:20) {
  for (s in 1:26) {
    sub_int <- post$a[i] + post$a_sid[i,s]
    sub_slope <- post$b[i] + post$b_sid[i,s]
    y = sub_int + sub_slope*xseq
    lines(xseq, inv_logit(y), col=grau(0.1))
  }
}
dev.off()
```





```{r}

resp.ulam2 <- ulam(
  alist(
    L ~ dbinom(1, p),
    logit(p) <- a_sid[sid] + b_sid[sid]*RDV,
    
    # adaptive priors
    transpar> vector[sid]:sid <- compose_noncentered( sigma_sid,
                                                      L_Rho,
                                                      z_sid),
    vector[sid]:z_sid ~ normal(0, 1)
    
    #fixed priors
    sigma_sid ~ dexp(1),
    cholesky_factor_corr:Rho ~ lkj_corr_cholesky( 2 )
    
    c(a_sid, b_sid)[sid] ~ multi_normal( c(a,b), Rho, sigma_sid),
    a ~ normal(5, 2),
    b ~ normal(-1, 0.5),
    sigma_sid ~ exponential(1),
    Rho ~ dlkjcorr(2)
  ), data = dat_listr, chains=1
)
```

When we say $y$ is normally distributed, we mean:
$$\begin{equation}
Normal(y|\mu, \sigma) = \frac{1}{\sigma\sqrt{2\pi}}
e^{-\frac{1}{2}(\frac{y-\mu}{\sigma})^2}
\end{equation}$$

However, if $y$ is the result of a **Wiener First Passage Time Distribution**, then:
$$\begin{equation}
\text{Wiener} (y|\alpha,\tau,\beta,\delta) = 
\frac{\alpha^3}{(y-\tau)^{3/2}} \text{exp}
\begin{pmatrix} -\delta \alpha \beta - \frac{\delta^2(y-\tau)}{2}
\end{pmatrix}
\sum_{k=-\infty }^{\infty}(2k+\beta)\phi
\begin{pmatrix} \frac{2k\alpha + \beta}{\sqrt{y - \tau}}
\end{pmatrix}
\end{equation}$$
where $\phi(x)$ is the standard normal density.

# Prepare data list for stan
```{r}
# number of subjects
N <-length(unique(d_trim$SID))
# count responses of each type
choice_counts <- d_trim %>%
  count(SID, Response)
# left responses
cl <- choice_counts %>% 
  filter(Response == 1)
# right responses
cr <- choice_counts %>%
  filter(Response == 2)
# minimum RT for each subject
min_RTs <- d_trim %>% 
  group_by(SID) %>% 
  summarize(RTs = min(RTs)) %>%
  pull(RTs)

# create list of RTs for each subject for each response type
Left <- matrix(-1, nrow=N, ncol=max(cl$n))
Right <- matrix(-1, nrow=N, ncol=max(cr$n))

for (i in 1:N) {
  #print(str_c('At [',i,' ',i,':cl$n[',i,']'))
  Left[i, 1:cl$n[i]] = d_trim %>%
    filter(Subj == i & Response == 1) %>%
    pull(RTs)
  
  Right[i, 1:cr$n[i]] = d_trim %>%
    filter(Subj == i & Response == 2) %>%
    pull(RTs)
}

# store everything in list
dat_list <- list(
  N = N,
  Nu_max = max(cl$n),
  Nl_max = max(cr$n),
  Nu = cl$n,
  Nl = cr$n,
  RTu = Left,
  RTl = Right,
  minRT = min_RTs,
  RTbound = .1
)

# Check dat_list
for (i in 1:dat_list$N) {
  # minimum RT must be less than recorded minimum RT
  minrt <- min(dat_list$RTu[i, 1:dat_list$Nu[i]])
  if (minrt < dat_list$RTbound) {
    print(str_c("Problem with subject ", i, 
                "minimum left RT is too low! [", minrt,"]"))
  }
  minrt <- min(dat_list$RTl[i, 1:dat_list$Nl[i]])
  if (minrt < dat_list$RTbound) {
    print(str_c("Problem with subject ", i, 
                "minimum right RT is too low! [", minrt,"]"))
  }
}

```



# DDMs

```{r}
fit <- rstan::stan(file = '../../scratch-foo/choice_ddm.stan', 
            data=dat_list, chains=4, cores=4)
```

```{r}
fit_b0 <- rstan::stan(file = '../../scratch-foo/choice_ddm_0bias.stan', 
            data=dat_list, chains=4, cores=4)
```

## attempt at value
```{r}
# create list of value diffs for each subject for each response type
VLeft <- matrix(-1, nrow=N, ncol=max(cl$n))
VRight <- matrix(-1, nrow=N, ncol=max(cr$n))

for (i in 1:N) {
  #print(str_c('At [',i,' ',i,':cl$n[',i,']'))
  VLeft[i, 1:cl$n[i]] = d_trim %>%
    filter(Subj == i & Response == 1) %>%
    pull(LeftAdjDiff)
  
  VRight[i, 1:cr$n[i]] = d_trim %>%
    filter(Subj == i & Response == 2) %>%
    pull(RightAdjDiff)
}
# store everything in list
dat_list <- list(
  N = N,
  Nu_max = max(cl$n),
  Nl_max = max(cr$n),
  Nu = cl$n,
  Nl = cr$n,
  RTu = Left,
  RTl = Right,
  minRT = min_RTs,
  RTbound = .1,
  RDVu = VLeft,
  RDVl = VRight
)

```

```{r}
x = seq(from=-5, to=5, length.out=50)
plot(x, 2^x)
```

```{r}
x = seq(from=-5, to=5, length.out=50)
plot(x, .5^x)
```

```{r}
nsim = 1e4
k <- rnorm(nsim, 0, 0.2)
p <- rnorm(nsim, 0, 0.2)
VL <- sample(-6:6, nsim, replace=TRUE)
s <- sample(c(-1,1), nsim, replace=TRUE)
d0 <- runif(nsim)

drifts <- vector(mode="numeric", length=nsim)
for (i in nsim) {
  drifts[i] <- k[i]*s[i]*abs(VL[i])^p[i] + d0[i]
}

summary(drifts)
```


```{r}
fit.val <- rstan::stan(file = '../../scratch-foo/choice_value_ddm.stan', 
            data=dat_list, chains=4, cores=4)

```



## Try ulam
```{r}
ufit <- rethinking::ulam(
  alist(
    
  )
)
```



## Use StanDDM
```{r}
require(StanDDM)
choice.df <- data.frame(
  suj = str_c("Subject", as.numeric(d_trim$SID)),
  rt = as.double(d_trim$RTs),
  crit = d_trim$LeftAdj - d_trim$RightAdj,
  cor = as.numeric(d_trim$ChooseLeft)
)

dat <- StanDDM::experimental_data_processing(choice.df)
```

```{r}
mod <- StanDDM::StanDDM(data=dat, include_models = c('sv'))
```





```{r}
choice.df <- data.frame(
  subjID = as.numeric(d_trim$SID),
  choice = as.numeric(d_trim$Response),
  RT = as.double(d_trim$RTs)
)

dat_list <- list(
  
)

choice_trim <- choice.df %>%
  filter( subjID %in% c(1,3,5,6))

choice.mod <- hBayesDM::choiceRT_ddm(choice_trim)
```

```{r}
plot(choice.mod, type="trace")
```

```{r}
plot(choice.mod)
```



```{r}
mod <- lmerTest::lmer(RT ~ ChoiceSupportDist*ChoiceMoralDist +
                    (1|SID) + (1|IssueLeft), data=d_trim)
summary(mod)

mod2 <- glmer(ChooseLeft ~ LeftSupport*LeftMoral +
                          (1|SID) + (1|IssueLeft),
                        data = d_trim, family=binomial)
```

```{r}
require(rethinking)
dat_list <- list(
  ChooseLeft = d_trim$ChooseLeft,
  M = d_trim$ChoiceMoral / 8,
  S = d_trim$ChoiceSupport / 6,
  Issue = as.numeric(d_trim$IssueLeft),
  SID = as.numeric(d_trim$SID)
)

modb <- ulam(
  alist(
    ChooseLeft ~ dbinom(1, p),
    logit(p) <- a[SID] + g[Issue] + bS*S + bM*M,
    bS ~ normal(0, 1),
    bM ~ normal(0, 1),
    a[SID] ~ dnorm(a_bar, sigma_a),
    g[Issue] ~ dnorm(0, sigma_g),
    a_bar ~ dnorm(0, 1.5),
    sigma_a ~ dexp(1),
    sigma_g ~ dexp(1)
  ), data = dat_list, chains=4, cores=4, log_lik=TRUE
)
```

```{r}
trankplot(modb)
```

```{r}
precis(modb)
```

